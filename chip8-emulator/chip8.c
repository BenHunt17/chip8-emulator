#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#include "cpu.h"
#include "Peripherals.h"

#include "chip8.h"

void chip8Start(uint8_t* program, int programSize) {
	Chip8State state = {
		.memory = { 0 },
		.registers = { 0 },
		.i = 0,
		.pc = PROGRAM_INDEX,
		.gfx = { 0 },
		.delayTimer = 0,
		.soundTimer = 0,
		.stack = { 0 },
		.sp = 0,
		.keys = { 0 },
		.keyWasDown = 0x0
	};

	initialiseMemory(state.memory, program, programSize);

	srand(time(NULL));

	PeripheralsLaunch(&state, 10);
}

void initialiseMemory(uint8_t* memory, uint8_t* program, int programSize) {
	uint8_t fontset[FONT_SET_SIZE] =
	{
	  0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
	  0x20, 0x60, 0x20, 0x20, 0x70, // 1
	  0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
	  0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
	  0x90, 0x90, 0xF0, 0x10, 0x10, // 4
	  0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
	  0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
	  0xF0, 0x10, 0x20, 0x40, 0x40, // 7
	  0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
	  0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
	  0xF0, 0x90, 0xF0, 0x90, 0x90, // A
	  0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
	  0xF0, 0x80, 0x80, 0x80, 0xF0, // C
	  0xE0, 0x90, 0x90, 0x90, 0xE0, // D
	  0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
	  0xF0, 0x80, 0xF0, 0x80, 0x80  // F
	};

	memcpy(memory + FONT_SET_INDEX, fontset, FONT_SET_SIZE); //Fontset is conventionally stored at 0x50 or "80" in memory
	memcpy(memory + PROGRAM_INDEX, program, programSize);
}